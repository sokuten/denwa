<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR P2P Phone</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: #fff; text-align: center; height: 100vh; margin: 0; box-sizing: border-box; }
  
  /* ã‚«ãƒ¡ãƒ©æ˜ åƒï¼ˆé¡ã®ã‚ˆã†ã«åè»¢ï¼‰ */
  video { width: 100%; max-width: 320px; border-radius: 12px; background: #000; transform: scaleX(-1); margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  
  /* QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #q { margin: 10px auto; padding: 10px; width: 220px; height: 220px; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 8px; }
  
  /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
  button { width: 100%; max-width: 320px; height: 56px; cursor: pointer; border: none; border-radius: 28px; background: #000; color: #fff; font-weight: bold; font-size: 16px; transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  button:active { transform: scale(0.98); }
  button:disabled { background: #ccc; cursor: default; }

  /* è£æ–¹ï¼ˆéš ã—è¦ç´ ï¼‰ */
  #t { width: 1px; height: 1px; opacity: 0; position: absolute; }
  #v { display: none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>

<video id="p" autoplay playsinline muted></video>
<div id="q">ã“ã“ã«QRãŒå‡ºã¾ã™</div>

<button id="b" onclick="start()">1. Start & Scan</button>

<audio id="v" autoplay></audio>
<textarea id="t"></textarea>

<script>
  // åŸºæœ¬è¨­å®š
  const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  const t = document.getElementById('t');
  const p = document.getElementById('p');
  const b = document.getElementById('b');
  const qd = document.getElementById('q');
  let scanning = false;
  let isConnected = false;

  // ç›¸æ‰‹ã®å£°ãŒå±Šã„ãŸã‚‰å†ç”Ÿ
  pc.ontrack = e => document.getElementById('v').srcObject = e.streams[0];

  // URLã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆiPhoneå´ã‹ã©ã†ã‹ï¼‰
  const urlParams = new URLSearchParams(window.location.search);
  const isAnswerSide = urlParams.has('s');

  if (isAnswerSide) { 
    t.value = atob(urlParams.get('s'));
    b.innerText = "2. Start Answer";
  }

  // â–  QRç”Ÿæˆã®å¿ƒè‡“éƒ¨ï¼ˆã“ã“ã‚’ä¿®æ­£æ¸ˆã¿ï¼‰
  const s = (isOffer) => {
    let qrGenerated = false;
    
    const gen = () => {
      if (qrGenerated) return; // äºŒé‡ç”Ÿæˆé˜²æ­¢
      qrGenerated = true;
      
      const sdp = JSON.stringify(pc.localDescription);
      // æ–‡å­—æ•°å‰Šæ¸›ã®ãŸã‚URLç”Ÿæˆ
      const url = window.location.origin + window.location.pathname + '?s=' + btoa(sdp);
      
      qd.innerHTML = "";
      new QRCode(qd, { text: url, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.L });
      
      if (isOffer) {
        b.innerText = "Scan Partner's QR";
      } else {
        b.innerText = "Show this QR to PC";
      }
      // QRãŒå‡ºãŸã‚‰ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
      startScan();
    };

    // å€™è£œãŒè¦‹ã¤ã‹ã‚‹ãŸã³ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŒã€é…ã„å ´åˆã¯1ç§’å¾Œã«å¼·åˆ¶å®Ÿè¡Œ
    pc.onicecandidate = e => { if (!e.candidate) gen(); };
    setTimeout(gen, 1000); 
  };

  // â–  é–‹å§‹å‡¦ç†
  async function start() {
    try {
      b.disabled = true;
      b.innerText = "Camera Starting...";
      
      // ã‚«ãƒ¡ãƒ©èµ·å‹•
      const stream = await navigator.mediaDevices.getUserMedia({audio: true, video: {facingMode: "user"}});
      p.srcObject = stream;
      
      // éŸ³å£°ã‚’å›ç·šã«ä¹—ã›ã‚‹
      stream.getTracks().forEach(tr => { if(tr.kind === 'audio') pc.addTrack(tr, stream); });

      if (isAnswerSide) {
        // iPhoneå´: å±Šã„ãŸæƒ…å ±ã‚’ã‚»ãƒƒãƒˆã—ã¦è¿”äº‹ã‚’ä½œã‚‹
        await pc.setRemoteDescription(JSON.parse(t.value));
        await pc.setLocalDescription(await pc.createAnswer());
        s(false);
      } else {
        // PCå´: è‡ªåˆ†ã‹ã‚‰ç™ºä¿¡ã™ã‚‹
        await pc.setLocalDescription(await pc.createOffer());
        s(true);
      }
    } catch (e) {
      alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
      b.disabled = false;
      b.innerText = "Retry";
    }
  }

  // â–  ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ï¼ˆç›¸æ‰‹ã®QRã‚’èª­ã¿å–ã‚‹ï¼‰
  function startScan() {
    if (scanning || isConnected) return;
    scanning = true;
    
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const tick = () => {
      if (!scanning || isConnected) return;
      
      if (p.readyState === p.HAVE_ENOUGH_DATA) {
        canvas.height = p.videoHeight;
        canvas.width = p.videoWidth;
        ctx.drawImage(p, 0, 0, canvas.width, canvas.height);
        
        // QRã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height, { inversionAttempts: "dontInvert" });
        
        if (code) {
          // QRãŒè¦‹ã¤ã‹ã£ãŸã‚‰URLã‹ãƒã‚§ãƒƒã‚¯
          try {
            const urlObj = new URL(code.data);
            const res = urlObj.searchParams.get('s');
            if (res) {
              // è‡ªåˆ†ãŒå‡ºã—ãŸQRã¨åŒã˜ã˜ã‚ƒãªã„ã‹ç¢ºèªï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
              if (res !== btoa(JSON.stringify(pc.localDescription))) {
                 connect(atob(res));
                 return;
              }
            }
          } catch(e) { /* ç„¡é–¢ä¿‚ãªQRã¯ç„¡è¦– */ }
        }
      }
      requestAnimationFrame(tick);
    };
    tick();
  }

  // â–  æ¥ç¶šå®Œäº†å‡¦ç†
  function connect(sdp) {
    if (isConnected) return;
    isConnected = true;
    scanning = false;
    
    pc.setRemoteDescription(JSON.parse(sdp));
    b.innerText = "CONNECTED!";
    b.style.background = "#28a745"; // ç·‘è‰²ã«å¤‰æ›´
    qd.innerHTML = "<div style='font-size:40px'>ğŸ“</div>"; // QRã‚’é›»è©±ã‚¢ã‚¤ã‚³ãƒ³ã«
    alert("ã¤ãªãŒã‚Šã¾ã—ãŸï¼");
  }
</script>
</body>
</html>
