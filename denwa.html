<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR P2P Phone (Zip)</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; background: #fff; text-align: center; height: 100vh; margin: 0; }
  
  /* カメラ映像 */
  video { width: 90%; max-width: 320px; border-radius: 12px; background: #000; transform: scaleX(-1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  
  /* QRコードエリア */
  #q { margin: 15px auto; padding: 10px; width: 260px; height: 260px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 8px; }
  
  /* ボタン */
  button { width: 90%; max-width: 320px; height: 60px; cursor: pointer; border: none; border-radius: 30px; background: #000; color: #fff; font-weight: bold; font-size: 18px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  button:disabled { background: #999; }
  button.connected { background: #28a745; }

  #t { position: absolute; opacity: 0; pointer-events: none; }
  #v { display: none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
</head>
<body>

<video id="p" autoplay playsinline muted></video>
<div id="q">ここにQRが出ます</div>
<button id="b" onclick="start()">1. Start & Scan</button>

<audio id="v" autoplay></audio>
<textarea id="t"></textarea>

<script>
  // 基本設定
  const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  const t = document.getElementById('t');
  const p = document.getElementById('p');
  const b = document.getElementById('b');
  const qd = document.getElementById('q');
  let scanning = false;
  let isConnected = false;

  pc.ontrack = e => document.getElementById('v').srcObject = e.streams[0];

  // URLパラメータ処理（圧縮データを解凍して復元）
  const urlParams = new URLSearchParams(window.location.search);
  const compressedParam = urlParams.get('s');

  if (compressedParam) { 
    try {
      // 圧縮されたデータを元のJSONに戻す
      const decompressed = LZString.decompressFromEncodedURIComponent(compressedParam);
      if (decompressed) {
        t.value = decompressed;
        b.innerText = "2. Start Answer";
      }
    } catch(e) { console.error("Decompress error", e); }
  }

  // ■ QR生成処理（ここでデータをギュッと圧縮します）
  const s = (isOffer) => {
    let qrGenerated = false;
    
    const gen = () => {
      if (qrGenerated) return; 
      qrGenerated = true;
      
      const sdpJson = JSON.stringify(pc.localDescription);
      
      // 【ここが新機能】データを圧縮して超短縮URL
